# Руководство по использованию Streamlit UI для SPY Trend Backtest

## Быстрый старт

### 1. Установка зависимостей

```bash
cd /Users/admin/Work/spy_trend
pip install -r requirements.txt
```

Основные библиотеки:
- `streamlit` — веб-интерфейс
- `plotly` — интерактивные графики
- `pandas`, `numpy` — анализ данных
- `yfinance` — загрузка данных SPY

### 2. Запуск приложения

```bash
streamlit run app.py
```

Приложение откроется автоматически в браузере по адресу `http://localhost:8501`

Если порт занят, Streamlit выберет другой порт (8502, 8503 и т.д.)

### 3. Остановка приложения

В терминале нажмите `Ctrl+C`

---

## Возможности приложения

### Режим 1: DD-Capped Optimization (Оптимизация с ограничением просадки)

**Что это?**
Находит лучшую стратегию, которая гарантированно не проседает больше заданного лимита (например, -20%).

**Как использовать:**

1. **Выбор стратегий** (левая панель):
   - F: Hysteresis Regime — фильтр тренда с гистерезисом (против ложных сигналов)
   - G: Vol-Scaled Sizing — размер позиции зависит от волатильности
   - H: ATR Dip Add-On — базовая позиция + докупка на просадках
   - I: Breakout or Dip — вход на пробое или на дипе

2. **Max Drawdown Cap** (слайдер):
   - От -30% до -5%
   - По умолчанию: -20%
   - Чем строже ограничение, тем консервативнее стратегия

3. **Risk Scale Grid** (масштаб риска):
   - Минимум/Максимум/Шаг
   - Например: 0.5–1.0 с шагом 0.1
   - `risk_scale=0.5` означает 50% от полного размера позиции

4. **Fold Pass Rate** (процент проходящих фолдов):
   - Сколько процентов валидационных периодов должны удовлетворять ограничению
   - По умолчанию: 80%

5. **Walk-Forward параметры**:
   - Train: сколько лет для обучения (по умолчанию 8)
   - Validation: сколько лет для валидации (по умолчанию 2)
   - Step: шаг сдвига окна (по умолчанию 2 года)
   - Holdout Start: с какой даты начинается тест (по умолчанию 2022-01-01)

6. **Нажмите кнопку "Run DD-Capped Optimization"**

**Что вы увидите:**

- **Прогресс-бар** — оптимизация каждой стратегии
- **Winner banner** (зелёный) — победившая стратегия с параметрами
- **"Explain Like I'm Busy"** (раскрывающийся блок):
  - Краткая рекомендация (TL;DR)
  - На что обратить внимание
  - Оценка рисков
  - Опционально: AI-объяснение (если настроен `ANTHROPIC_API_KEY`)
- **Ranking table** — рейтинг всех стратегий по OOS CAGR
- **Вкладки**:
  1. **Stitched WF OOS** — сшитая эквити из всех валидационных периодов
  2. **Holdout** — тест на holdout-периоде (2022+)
  3. **Full Period** — весь исторический период (для справки)
  4. **Fold Details** — детали по каждому фолду

**Интерактивные графики:**
- Наведите курсор — увидите значения
- Zoom: выделите область мышью
- Pan: двойной клик → drag
- Легенда: клик на название → скрыть/показать

---

### Режим 2: Single Strategy Backtest (Тест одной стратегии)

**Что это?**
Быстрый тест любой стратегии с вашими параметрами.

**Как использовать:**

1. Выберите режим **"Single Strategy Backtest"** в радио-кнопках
2. Выберите стратегию из выпадающего списка (A–I)
3. Введите параметры:
   - Автоматически генерируются поля для параметров выбранной стратегии
   - Значения по умолчанию берутся из первого элемента grid
4. Настройте `risk_scale` (слайдер 0.1–1.0)
5. Нажмите **"Run Backtest"**

**Что вы увидите:**

- **Метрики** (5 карточек сверху):
  - Full CAGR / Sharpe / MaxDD
  - Holdout CAGR / MaxDD
- **Вкладки**:
  - **Full Period**: график эквити + просадок за весь период
  - **Holdout**: график для holdout-периода
- **Таблица метрик** под каждым графиком

---

## Интерпретация результатов

### Метрики

- **CAGR** (Compound Annual Growth Rate) — среднегодовая доходность
- **Sharpe** — доходность на единицу риска (чем выше, тем лучше)
- **Calmar** — CAGR / |MaxDD| (доходность на единицу просадки)
- **MaxDD** (Max Drawdown) — максимальная просадка от пика
- **Sortino** — как Sharpe, но учитывает только негативную волатильность
- **Win Rate** — процент прибыльных сделок
- **Profit Factor** — сумма прибылей / сумма убытков
- **Exposure %** — процент времени в рынке
- **Avg Trade Duration** — средняя длительность сделки (дни)
- **Trades/Year** — количество сделок в год

### Цвета графиков

- **Синий (#1f77b4)** — F_hysteresis_regime
- **Оранжевый (#ff7f0e)** — G_sizing_regime
- **Зелёный (#2ca02c)** — H_atr_dip_addon
- **Красный (#d62728)** — I_breakout_or_dip
- **Серый (#7f7f7f)** — Buy & Hold

### Что значит "DD-cap passed"?

Стратегия прошла все 3 условия:
1. ≥80% фолдов имеют MaxDD лучше капа (например, ≥ -20%)
2. Сшитая OOS эквити имеет MaxDD лучше капа
3. Средняя экспозиция ≥ 60%

---

## Расширенные настройки

### Costs (Комиссии)

- **Commission (bps/side)** — комиссия за сделку в базисных пунктах
  - 1.0 bps = 0.01% за одну сторону сделки
  - По умолчанию: 1 bps
- **Slippage (bps/side)** — проскальзывание
  - По умолчанию: 2 bps

Итого транзакционные издержки: (1+2) × 2 = **6 bps на полный цикл** (вход + выход)

### Walk-Forward окна

**Стандартная настройка:**
- Train: 8 лет
- Validation: 2 года
- Step: 2 года
- Результат: ~10 фолдов с 1993 по 2022

**Если хотите больше фолдов:**
- Уменьшите Step (например, 1 год)

**Если мало данных:**
- Уменьшите Train/Val

---

## Частые вопросы

### 1. Почему стратегия не прошла DD-cap?

**Причины:**
- Слишком строгий DD-cap (например, -10% очень сложно выдержать)
- Недостаточно гибкий risk_scale grid (попробуйте 0.3–1.0)
- Стратегия слишком агрессивная (попробуйте G или H вместо F/I)

**Решение:**
- Ослабьте DD-cap (например, с -15% до -20%)
- Добавьте меньшие risk_scale (0.3, 0.4)
- Выберите vol-scaled стратегии (G, H)

### 2. Почему holdout MaxDD хуже, чем stitched OOS MaxDD?

**Это нормально!** Holdout — полностью out-of-sample период. Стратегия оптимизировалась на данных до 2022 года, поэтому holdout может быть хуже.

### 3. Как выбрать между стратегиями с близкими OOS CAGR?

Смотрите на:
1. **Fold Pass %** — чем выше, тем стабильнее
2. **Stitched MaxDD** — чем меньше, тем лучше защита от просадок
3. **Exposure %** — ниже экспозиция = меньше времени в риске

### 4. Почему оптимизация долго идёт?

**DD-capped режим** проверяет каждый набор параметров на всех фолдах:
- F: 54 параметра × 6 risk_scale = 324 комбинации
- I: 96 параметра × 6 risk_scale = 576 комбинаций
- 4 стратегии × ~10 фолдов = ~1800 backtests

**Время:** ~2-3 минуты на современном компьютере.

**Ускорение:**
- Уменьшите количество стратегий
- Уменьшите risk_scale grid (например, только [0.7, 0.8, 0.9, 1.0])

### 5. Можно ли запустить на своих данных?

Да! Измените файл `data.py`:
- Замените `yfinance.download("SPY", ...)` на свой тикер
- Или загрузите CSV и замените функцию `download_spy()`

---

## Примеры использования

### Пример 1: Консервативная стратегия (максимальная защита)

```
Режим: DD-Capped Optimization
Стратегии: F, G, H, I (все)
DD Cap: -10%
Risk Scale: 0.3 – 0.8, шаг 0.1
Fold Pass Rate: 90%
Min Exposure: 50%
```

**Результат:** Скорее всего победит G_sizing_regime с низким risk_scale (0.5–0.6).

### Пример 2: Агрессивная стратегия (баланс доходности и риска)

```
Режим: DD-Capped Optimization
Стратегии: F, I
DD Cap: -25%
Risk Scale: 0.8 – 1.0, шаг 0.1
Fold Pass Rate: 70%
Min Exposure: 70%
```

**Результат:** F_hysteresis_regime с risk_scale=1.0, высокая доходность.

### Пример 3: Быстрый тест идеи

```
Режим: Single Strategy Backtest
Стратегия: F_hysteresis_regime
Параметры: regime_len=200, upper_pct=2.0, lower_pct=1.0, slope_window=20
risk_scale: 1.0
```

**Результат:** Сразу увидите эквити и метрики.

---

## Дополнительные возможности

### AI-объяснение (опционально)

Если у вас есть API-ключ Anthropic:

```bash
export ANTHROPIC_API_KEY="sk-ant-..."
streamlit run app.py
```

В блоке "Explain Like I'm Busy" появится кнопка **"Get AI Explanation"** — Claude объяснит результаты простым языком.

### Headless режим (без браузера)

```bash
streamlit run app.py --server.headless true
```

Полезно для удалённых серверов.

### Другой порт

```bash
streamlit run app.py --server.port 8080
```

---

## Troubleshooting

### Ошибка: "ModuleNotFoundError: No module named 'streamlit'"

```bash
pip install streamlit
```

### Ошибка: "Address already in use"

Порт 8501 занят. Остановите предыдущий процесс:

```bash
pkill -f "streamlit run"
streamlit run app.py
```

### Приложение не открывается автоматически

Откройте вручную: `http://localhost:8501`

### Данные не загружаются

Проверьте интернет-соединение (для скачивания SPY с yfinance).
Если данные уже есть, приложение использует кеш (`spy_daily.csv`).

### Графики не отображаются

Обновите браузер (Ctrl+F5) или попробуйте другой браузер (Chrome, Firefox).

---

## Контакты и поддержка

- **Исходный код:** `/Users/admin/Work/spy_trend/`
- **Документация:** `README.md`
- **Тесты:** `pytest tests/ -v`

Приложение готово к использованию. Запустите `streamlit run app.py` и исследуйте стратегии!
